{% extends "base.html" %}

{% block title %}Admin Dashboard - User Registration{% endblock %}

{% block content %}
<div class="header">
    <h1>Registration Requests</h1>
    <div class="user-info">Logged in as: <strong>{{ admin_user }}</strong></div>
</div>

<p class="info-text">
    <strong>Note:</strong> lldap is the single source of truth for user management.
    Approve requests to create users in lldap. Manage active users directly in lldap.
</p>

<h2>Pending Requests ({{ pending|length }})</h2>
{% if pending %}
<table>
    <thead>
        <tr>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
            <th>Reason</th>
            <th>Submitted</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for req in pending %}
        <tr>
            <td><strong>{{ req.username }}</strong></td>
            <td>{{ req.first_name }} {{ req.last_name }}</td>
            <td>{{ req.email }}</td>
            <td>{{ req.reason or '-' }}</td>
            <td>{{ req.created_at[:19] }}</td>
            <td>
                <form method="post" action="/admin/approve/{{ req.id }}" style="display: inline; margin-right: 0.5rem;">
                    <button type="submit" class="btn-success"
                            onclick="return confirm('Approve this user and create account in lldap?')">
                        Approve
                    </button>
                </form>
                <form method="post" action="/admin/reject/{{ req.id }}" style="display: inline;">
                    <input type="text" name="reason" placeholder="Rejection reason (optional)"
                           style="width: 200px; margin-right: 0.5rem;">
                    <button type="submit" class="btn-danger"
                            onclick="return confirm('Reject this request?')">
                        Reject
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">No pending requests</div>
{% endif %}

<h2>Audit Log ({{ audit_log|length }} recent)</h2>
<p class="info-text" style="font-size: 0.9rem; color: #666;">
    Historical record of all approval and rejection decisions.
    To manage active users, use the lldap admin interface.
</p>

{% if audit_log %}
<table>
    <thead>
        <tr>
            <th>Action</th>
            <th>Username</th>
            <th>Name</th>
            <th>Email</th>
            <th>Reviewed By</th>
            <th>Date</th>
            <th>Reason</th>
        </tr>
    </thead>
    <tbody>
        {% for entry in audit_log %}
        <tr>
            <td>
                {% if entry.action == 'APPROVED' %}
                <span class="badge badge-success">Approved</span>
                {% else %}
                <span class="badge badge-danger">Rejected</span>
                {% endif %}
            </td>
            <td><strong>{{ entry.username }}</strong></td>
            <td>{{ entry.first_name }} {{ entry.last_name }}</td>
            <td>{{ entry.email }}</td>
            <td>{{ entry.performed_by }}</td>
            <td>{{ entry.reviewed_at[:19] }}</td>
            <td>
                {% if entry.action == 'REJECTED' %}
                {{ entry.rejection_reason or '-' }}
                {% else %}
                -
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="empty-state">No audit log entries yet</div>
{% endif %}
{% endblock %}
